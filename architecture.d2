# AI Media Indexer: High-Density Technical Schematic
# AUDITED: 2024-01-25 | 100% Code-Aligned

direction: right

# Global Styles (Optimized for 1024px Density)
classes: {
    model: {
        style: { fill: "#4caf50"; stroke: "#2e7d32"; font-color: "#ffffff"; border-radius: 4; font-size: 20; bold: true }
    }
    logic: {
        style: { fill: "#2196f3"; stroke: "#1565c0"; font-color: "#ffffff"; border-radius: 4; font-size: 20; bold: true }
    }
    infra: {
        style: { fill: "#9c27b0"; stroke: "#6a1b9a"; font-color: "#ffffff"; border-radius: 4; font-size: 18 }
    }
    data: {
        style: { fill: "#ff9800"; stroke: "#ef6c00"; font-color: "#ffffff"; border-radius: 4; font-size: 18; bold: true }
    }
}

# ENTRY & ORCHESTRATION
entry: {
  direction: down
  style.stroke: transparent
  
  sys: {
    direction: right
    style: { fill: "#f3e5f5"; stroke: "#7b1fa2"; stroke-width: 2; border-radius: 8 }
    arbiter: "ResourceArbiter\n(GPU Semaphore)" { class: infra }
    jobs: "JobManager\n(Crash Recovery)" { class: infra }
    arbiter <-> jobs
  }
}

# MULTIMODAL INGESTION PIPELINE (HIGH DENSITY)
ingestion: {
  style.stroke: transparent
  direction: right
  
  audio: {
    style: { fill: "#f8f9fa"; stroke: "#dee2e6"; border-radius: 8 }
    direction: right
    
    pre: {
      direction: down
      style.stroke: transparent
      lang: "Multi-pass Lang Detect\n(Confidence < 60% Retry)" { class: logic }
      content_class: "ContentClassifier\n(Speech/Music/Silence)" { class: model }
      lang -> content_class
    }
    
    asr: "ASR Council\n(ROVER Word Voting)" {
      class: model
      whisper: "Whisper v3" { shape: parallelogram; class: model }
      indic: "IndicConformer\n(AI4Bharat)" { shape: parallelogram; class: model }
      seamless: "SeamlessM4T v2" { shape: parallelogram; class: model }
    }
    
    analysis: {
      direction: down
      style.stroke: transparent
      dia: "Diarization\n(Pyannote 3.1)" { class: model }
      ser: "Speech Emotion (SER)" { class: model }
      music: "Music Structure\n(Chorus/Drop)" { class: model }
      clap: "CLAP\n(Auditory Events)" { class: model }
    }
    
    pre -> asr -> analysis
  }

  video: {
    style: { fill: "#f8f9fa"; stroke: "#dee2e6"; border-radius: 8 }
    direction: right
    
    sample: "Text-Gated\nSmart Sampler" { class: logic }
    
    vision: "Video Council\n(Multimodal Synthesis)" {
      class: model
      intern: "InternVideo2.5" { shape: parallelogram; class: model }
      bind: "LanguageBind" { shape: parallelogram; class: model }
      sam: "SAM 2 (Tracking)" { shape: parallelogram; class: model }
    }
    
    metadata: {
      direction: down
      style.stroke: transparent
      faces: "InsightFace (512D)\nArcFace Identity" { class: model }
      ocr: "PP-OCRv5\n(Indic Support)" { class: model }
      cinematog: "Cinematography\n(Netflix Shot Type)" { class: model }
      aesthetic: "Aesthetic Scoring\n(Apple Photos style)" { class: model }
    }
    
    sample -> vision -> metadata
  }
}

entry.sys -> ingestion.audio.pre
entry.sys -> ingestion.video.sample

# TEMPORAL FUSION HUB (COHERENCE ENGINE)
hub: {
  direction: right
  style: { fill: "#e3f2fd"; stroke: "#1976d2"; stroke-width: 4; border-radius: 12 }
  fusion: "Temporal Context Hub\n(XMem + SceneletBuilder)" { class: logic; style.font-size: 28 }
  clustering: "HDBSCAN Global\nIdentity Clustering" { class: logic }
  fusion <-> clustering
}

ingestion.audio.analysis -> hub.fusion
ingestion.video.metadata -> hub.fusion

# DATA LAKE & AGENTIC SEARCH
delivery: {
  direction: right
  style.stroke: transparent
  
  storage: {
    style: { fill: "#fff3e0"; stroke: "#ffe0b2"; border-radius: 8 }
    direction: right
    graph: "Identity Graph\n(SQL GraphRAG)" { shape: cylinder; class: data }
    qdrant: "QDRANT\n(Dense/Sparse/Multi-V)" {
      shape: cylinder
      class: data
      scenes: "Scenes"
      scenelets: "5s Scenelets"
      masklets: "SAM Masklets"
    }
  }
  
  search: {
    style: { fill: "#e1f5fe"; stroke: "#b3e5fc"; stroke-width: 3; border-radius: 12 }
    direction: down
    query: "LLM Query Expansion\n(Dynamic Context)" { class: model }
    engines: "SOTA Embedders\n(NV-Embed-v2 / BGE-M3)" { class: model }
    rrf: "Hybrid RRF Fusion\n(0.7v / 0.3k / 0.1s)" { class: logic }
    rerank: "Reranking Council\n(Reasoning Traces)" { class: model }
    query -> engines -> rrf -> rerank
  }
}

hub.fusion -> delivery.storage
delivery.storage.qdrant -> delivery.search.rrf
